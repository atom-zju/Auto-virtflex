cscope 15 $HOME/auto-virtflex-tmp               0000009428
	@cpu.cpp

	@cpu.h

1 #iâdeà
CPU_H


2 
	#CPU_H


	)

5 şas 
	cıu
{

6 
	mpublic
:

7 
ıuid
;

8 
boŞ
 
	m’abËd
;

10 
	$ıu
(
id
, 
boŞ
 
’
): 
	`ıuid
(id), 
	$’abËd
(
’
) {}

12 
	`’abË
();

13 
	`di§bË
();

15 
šlše
 
boŞ
 
İ”©Ü
<(cÚ¡ 
ıu
& 
rhs
) const {

16  
ıuid
 < 
rhs
.cpuid;

17 
	}
}

18 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
ıu
& 
rhs
) const {

19  
ıuid
 =ğ
rhs
.cpuid;

	@main.cpp

1 
	~"tİo_chªge_d.h
"

3 
	$maš
(){

4 
tİo_chªge_d
 
tİod
;

5 
tİod
.
	`upd©e_vm_m­
();

8 
	}
}

	@node.cpp

	@node.h

1 #iâdeà
NODE_H


2 
	#NODE_H


	)

4 
	~<£t
>

5 
	~"ıu.h
"

7 
usšg
 
Çme¥aû
 
	g¡d
;

9 şas 
	cnode
{

10 
	mpublic
:

11 
²ode_id
;

12 
	mÿ·c™y
;

13 
	m£t
<
	mıu
> 
	mıu_£t
;

14 
	mbw_u§ge
;

15 
	mts
;

17 
	$node
(
id
): 
	$²ode_id
(
id
) {}

18 
	$node
(){
	}
}

	@pnode.cpp

	@pnode.h

1 #iâdeà
PNODE_H


2 
	#PNODE_H


	)

3 
	~<veùÜ
>

4 
	~"node.h
"

5 
	~"vnode.h
"

7 
usšg
 
Çme¥aû
 
	g¡d
;

9 şas 
	c²ode
: 
public
 
node
 {

10 
veùÜ
<
vnode
*> 
vnode_li¡
;

11 
	$²ode
(
id
):
	$node
(
id
) {}

13 
	}
};

	@topo_change_d.cpp

1 
	~<io¡»am
>

2 
	~"tİo_chªge_d.h
"

3 
	~"ut.h
"

4 
usšg
 
Çme¥aû
 
	g¡d
;

6 
vm
* 
	gtİo_chªge_d
::
	$g‘_vm_by_id
(
id
){

7 if(
vm_m­
.
	`fšd
(
id
è!ğvm_m­.
	`’d
()){

8  
vm_m­
[
id
];

10  
NULL
;

11 
	}
}

13 
	gtİo_chªge_d
::
	$tİo_chªge_d
(){

14 
ts
 = 0;

15 
xs
 = 
	`xs_d«mÚ_İ’
();

16 iàĞ
xs
 =ğ
NULL
 ) {

17 
	`³¼Ü
("Error when connectingo‡ xs daemon\n");

18 
	`ex™
(-1);

20 
	}
}

22 
	gtİo_chªge_d
::~
	$tİo_chªge_d
(){

24 auto& 
x
: 
vm_m­
){

25 
d–‘e
 
x
.
£cÚd
;

28 auto& 
x
: 
²ode_li¡
){

29 
d–‘e
 
x
;

31 
	`xs_d«mÚ_şo£
(
xs
);

33 
	}
}

35 
	gtİo_chªge_d
::
	$upd©e_vm_m­
(){

36 
ts
++;

37 
veùÜ
<
¡ršg
> 
dœ
;

38 
	`li¡_x’¡Üe_dœeùÜy
(
xs
, 
	`¡ršg
("/loÿl/domaš"), 
dœ
);

39 
cout
<<"/loÿl/domaš"<< 
’dl
;

40 auto& 
x
: 
dœ
){

41 
vm_id
 = 
	`¡oi
(
x
);

42 
cout
 <<"\t" <<"VM: "<<
	`¡oi
(
x
è<< 
’dl
;

43 if(
vm_m­
.
	`fšd
(
vm_id
è=ğvm_m­.
	`’d
()){

44 
vm
* 
v
 = 
Ãw
 
	`vm
(
vm_id
, 
this
, 
	`¡ršg
("/loÿl/domaš/").
	`­³nd
(
x
));

45 
v
->
	`upd©e_vnode_m­
(
ts
);

46 
vm_m­
[
vm_id
] = 
v
;

50 
vm_m­
[
vm_id
]->
	`upd©e_vnode_m­
(
ts
);

55 auto& 
x
: 
vm_m­
){

56 autØ
v
 = 
x
.
£cÚd
;

57 if(
v
->
ts
 <s){

58 
d–‘e
 
v
;

59 
vm_m­
.
	`”a£
(
x
.
fœ¡
);

63 
	}
}

65 
	gtİo_chªge_d
::
	$shršk_vm
(
id
, 
vnode_id
){

66 
vm
* 
v
 = 
	`g‘_vm_by_id
(
id
);

67 if(!
v
)

68 
cout
<<"Didn'ˆfšd vm " << 
id
 << "šİo_chªge_d::shršk_vm" <<
’dl
;

69  
v
->
	`shršk_vnode
(
vnode_id
);

70 
	}
}

71 
	gtİo_chªge_d
::
	$ex·nd_vm
(
id
, 
vnode_id
){

72 
vm
* 
v
 = 
	`g‘_vm_by_id
(
id
);

73 if(!
v
)

74 
cout
<<"Didn'ˆfšd vm " << 
id
 << "šİo_chªge_d::ex·nd_vm" <<
’dl
;

75  
v
->
	`ex·nd_vnode
(
vnode_id
);

76 
	}
}

	@topo_change_d.h

1 #iâdeà
TOPO_CHANGE_D_H


2 
	#TOPO_CHANGE_D_H


	)

4 
	~<unÜd”ed_m­
>

5 
	~"vm.h
"

6 
	~"²ode.h
"

7 
	~"ut.h
"

9 şas 
	ctİo_chªge_ev’t
{

10 
	mpublic
:

11 
vm_id
;

12 
	mvnode_id
;

13 
	maùiÚ
;

16 şas 
	ctİo_chªge_d
 {

17 
ä›nd
 
şass
 
	mvm
;

18 
ä›nd
 
şass
 
	mvnode
;

19 
	m´iv©e
:

20 
unÜd”ed_m­
<, 
	mvm
*> 
	mvm_m­
;

21 
	mveùÜ
<
	m²ode
*> 
	m²ode_li¡
;

22 
	mveùÜ
<
	mtİo_chªge_ev’t
> 
	mev’t_li¡
;

23 
xs_hªdË
 *
	mxs
;

24 
	mts
;

26 
vm
* 
g‘_vm_by_id
(
id
);

27 
add_vm
(
vm
*);

28 
»move_vm
(
id
);

30 
	mpublic
:

31 
shršk_vm
(
id
, 
vnode_id
);

32 
ex·nd_vm
(
id
, 
vnode_id
);

34 
š™_²ode_li¡
();

36 
upd©e_vm_m­
();

37 
upd©e_²ode_li¡
();

39 
g’”©e_ev’ts
();

40 
´oûss_ev’ts
();

42 
tİo_chªge_d
();

43 ~
tİo_chªge_d
();

	@util.cpp

1 
	~"ut.h
"

2 
	~<c¡dlib
>

3 
	~<c¡dio
>

4 
	~<c¡ršg
>

7 
	$wr™e_to_x’¡Üe_·th
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, cÚ¡ sŒšg 
v®ue
){

9 
xs_Œª§ùiÚ_t
 
th
;

11 
”
;

13 
th
 = 
	`xs_Œª§ùiÚ_¡¬t
(
xs
);

14 
”
 = 
	`xs_wr™e
(
xs
, 
th
, 
·th
.
	`c_¡r
(), 
v®ue
.c_¡r(), 
	`¡¾’
(value.c_str()));

15 
	`xs_Œª§ùiÚ_’d
(
xs
, 
th
, 
çl£
);

17 ià(
”
 == 0){

18 
	`årštf
(
¡d”r
, "çØwr™tØ·th: %s\n", 
·th
.
	`c_¡r
());

24 
	}
}

26 
	$»ad_äom_x’¡Üe_·th
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, sŒšg& 
s
){

28 
xs_Œª§ùiÚ_t
 
th
;

30 * 
buf
;

31 
Ën
;

33 
th
 = 
	`xs_Œª§ùiÚ_¡¬t
(
xs
);

34 
buf
 = (*)
	`xs_»ad
(
xs
, 
th
, 
·th
.
	`c_¡r
(), &
Ën
);

35 
	`xs_Œª§ùiÚ_’d
(
xs
, 
th
, 
çl£
);

37 ià(!
buf
){

38 
	`årštf
(
¡d”r
, "çØ»ad from…©h: %s\n", 
·th
.
	`c_¡r
());

41 
s
.
	`ş—r
();

42 
s
.
	`­³nd
(
buf
);

43 
	`ä“
(
buf
);

46 
	}
}

48 
li¡_x’¡Üe_dœeùÜy
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, 
veùÜ
<¡ršg>& 
»s
){

49 
xs_Œª§ùiÚ_t
 
	gth
;

50 
	gnum
;

52 ** 
	gli¡
;

53 
	gth
 = 
xs_Œª§ùiÚ_¡¬t
(
xs
);

54 
	gli¡
 = 
xs_dœeùÜy
(
xs
, 
th
, 
·th
.
c_¡r
(), &
num
);

55 
xs_Œª§ùiÚ_’d
(
xs
, 
th
, 
çl£
);

57 if(!
	gli¡
){

58 
årštf
(
¡d”r
, "çØ»ad x dœeùÜy: %s\n", 
·th
.
c_¡r
());

62 
	g»s
.
ş—r
();

63 
	gi
=0; i<
	gnum
; i++){

64 
	g»s
.
push_back
(
¡ršg
(
li¡
[
i
]));

67 
ä“
(
li¡
);

	@util.h

1 #iâdeà
UTIL_H


2 
	#UTIL_H


	)

4 
	~<veùÜ
>

5 
	~<¡ršg
>

8 
	~<x’¡Üe.h
>

11 
usšg
 
Çme¥aû
 
¡d
;

14 
wr™e_to_x’¡Üe_·th
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, cÚ¡ sŒšg 
v®ue
);

16 
»ad_äom_x’¡Üe_·th
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, sŒšg& 
s
);

18 
li¡_x’¡Üe_dœeùÜy
(
xs_hªdË
* 
xs
, cÚ¡ 
¡ršg
 
·th
, 
veùÜ
<¡ršg>& 
»s
);

	@vm.cpp

1 
	~<io¡»am
>

2 
	~<veùÜ
>

3 
	~"vm.h
"

4 
	~"tİo_chªge_d.h
"

6 
usšg
 
Çme¥aû
 
	g¡d
;

8 
vnode
* 
	gvm
::
	$g‘_vnode_by_id
(
id
){

9 if(
vnode_m­
.
	`fšd
(
id
è!ğvnode_m­.
	`’d
()){

10  
vnode_m­
[
id
];

12  
NULL
;

13 
	}
}

15 
	gvm
::~
	$vm
(){

16 auto& 
x
: 
vnode_m­
){

17 
d–‘e
 
x
.
£cÚd
;

19 
cout
 << "vm: " << 
vm_id
 << "”mš©ed." << 
’dl
;

20 
	}
}

22 
	gvm
::
	$upd©e_vnode_m­
(
ts
){

23 
this
->
ts
 =s;

24 
veùÜ
<
¡ršg
> 
dœ
;

25 
¡ršg
 
node_·th
 = 
	`¡ršg
(
xs_·th
).
	`­³nd
("/numa/node");

26 
	`li¡_x’¡Üe_dœeùÜy
(
tİod
->
xs
, 
node_·th
, 
dœ
);

28 
cout
 << 
node_·th
 <<
’dl
;

29 auto& 
x
: 
dœ
){

30 
cout
<< "\t"<< 
x
 << 
’dl
;

31 
node_id
 = 
	`¡oi
(
x
);

32 if(
vnode_m­
.
	`fšd
(
node_id
è=ğvnode_m­.
	`’d
()){

33 
vnode
* 
v
 = 
Ãw
 
	`vnode
(
node_id
, 
	`¡ršg
(
node_·th
).
	`­³nd
("/").­³nd(
x
), 
this
, 
tİod
);

34 
v
->
	`upd©e_node
(
ts
);

35 
vnode_m­
[
node_id
] = 
v
;

39 
vnode_m­
[
node_id
]->
	`upd©e_node
(
ts
);

45 auto& 
x
: 
vnode_m­
){

46 autØ
v
 = 
x
.
£cÚd
;

47 if(
v
->
ts
 <s){

48 
d–‘e
 
v
;

49 
vnode_m­
.
	`”a£
(
x
.
fœ¡
);

52 
	}
}

55 
	gvm
::
	$shršk_vnode
(
id
){

56 
vnode
* 
v
 = 
	`g‘_vnode_by_id
(
id
);

57 if(!
v
)

58 
cout
<< "Didn'ˆfšd vnod" << 
id
 << " iÀvm::shršk_vnode" <<
’dl
;

59  
v
->
	`shršk
();

60 
	}
}

61 
	gvm
::
	$ex·nd_vnode
(
id
){

62 
vnode
* 
v
 = 
	`g‘_vnode_by_id
(
id
);

63 if(!
v
)

64 
cout
<< "Didn'ˆfšd vnod" << 
id
 << " iÀvm::ex·nd_vnode" <<
’dl
;

65  
v
->
	`ex·nd
();

66 
	}
}

	@vm.h

1 #iâdeà
VM_H


2 
	#VM_H


	)

4 
	~<unÜd”ed_m­
>

5 
	~"vnode.h
"

7 
usšg
 
Çme¥aû
 
	g¡d
;

9 
şass
 
	gtİo_chªge_d
;

11 şas 
	cvm
{

13 
	mpublic
:

14 
vm_id
;

15 
	munÜd”ed_m­
<, 
	mvnode
*> 
	mvnode_m­
;

16 
¡ršg
 
	mxs_·th
;

17 
tİo_chªge_d
* 
	mtİod
;

18 
	mts
;

20 
vnode
* 
g‘_vnode_by_id
(
id
);

21 
add_vnode
(
vnode
*);

22 
»move_vnode
(
id
);

24 
shršk_vnode
(
id
);

25 
ex·nd_vnode
(
id
);

27 
upd©e_vnode_m­
(
ts
);

29 
	$vm
(
id
, 
tİo_chªge_d
* 
d
,
¡ršg
 
s
): 
	`xs_·th
(s), 
	`tİod
(d), 
	$vm_id
(
id
){}

30 ~
	`vm
();

32 
	}
};

	@vnode.cpp

1 
	~"vnode.h
"

2 
	~"tİo_chªge_d.h
"

3 
	~<io¡»am
>

4 
	~<ÿs£¹
>

6 
	gvnode
::
	$upd©e_node
(
ts
){

7 
this
->
ts
 =s;

9 
¡ršg
 
tmp
;

10 
veùÜ
<
¡ršg
> 
tmp_li¡
;

12 
	`as£¹
(
tİod
);

13 
	`»ad_äom_x’¡Üe_·th
(
tİod
->
xs
, 
	`¡ršg
(
xs_·th
).
	`­³nd
("/ÿ·c™y"), 
tmp
);

14 
ÿ·c™y
 = 
	`¡oi
(
tmp
);

15 
cout
 << "ÿ·c™y: " << 
ÿ·c™y
 <<
’dl
;

17 
	`»ad_äom_x’¡Üe_·th
(
tİod
->
xs
, 
	`¡ršg
(
xs_·th
).
	`­³nd
("/rg‘"), 
tmp
);

18 
rg‘
 = 
	`¡oi
(
tmp
);

19 
cout
 << "rg‘: " << 
rg‘
 <<
’dl
;

23 
low_rg‘
 = (80*1024 + 
ÿ·c™y
/1024*17);

24 
cout
 << "low_rg‘: " << 
low_rg‘
 << 
’dl
;

27 
	`li¡_x’¡Üe_dœeùÜy
(
tİod
->
xs
, 
	`¡ršg
(
xs_·th
).
	`­³nd
("/vıu"),
tmp_li¡
);

28 auto& 
x
: 
tmp_li¡
){

29 
cout
<< "vıu: " << 
x
 <<
’dl
;

30 
ıu_£t
.
	`š£¹
(
	`ıu
(
	`¡oi
(
x
),
Œue
));

33 
	}
}

35 
	gvnode
::
	$shršk
(){

39 
¡ršg
 
	`tİo_chªge_æag
(
xs_·th
.
	`sub¡r
(0, xs_·th.
	`fšd_Ï¡_of
("/\\")));

40 
tİo_chªge_æag
 =İo_chªge_æag.
	`sub¡r
(0,İo_chªge_æag.
	`fšd_Ï¡_of
("/\\"));

41 
tİo_chªge_æag
.
	`­³nd
("/topo_change");

42 
cout
 << "tİo_chªge_æag…©h: " << 
tİo_chªge_æag
 << 
’dl
;

44 
	`as£¹
(
tİod
);

45 
	`wr™e_to_x’¡Üe_·th
(
tİod
->
xs
, 
tİo_chªge_æag
,
	`¡ršg
("2"));

46 
	`wr™e_to_x’¡Üe_·th
(
tİod
->
xs
, 
	`¡ršg
(
xs_·th
).
	`­³nd
("/rg‘"),
	`to_¡ršg
(
low_rg‘
));

50 
	}
}

52 
	gvnode
::
	$ex·nd
(){

55 
	}
}

	@vnode.h

1 #iâdeà
VNODE_H


2 
	#VNODE_H


	)

4 
	~<¡ršg
>

5 
	~"node.h
"

7 
şass
 
	gvm
;

8 
şass
 
	gtİo_chªge_d
;

10 şas 
	cvnode
: 
public
 
node
{

11 
public
:

12 
vm
* 
owÃr_vm
;

13 
	mvnode_id
;

14 
	mrg‘
;

15 
	mlow_rg‘
;

16 
¡ršg
 
	mxs_·th
;

17 
tİo_chªge_d
* 
	mtİod
;

19 
upd©e_node
(
ts
);

21 
shršk
();

22 
ex·nd
();

24 
	$vnode
(
vnode_id
, 
¡ršg
 
·th
, 
vm
* 
o
, 
tİo_chªge_d
* 
t
):

25 
	`vnode_id
(
vnode_id
), 
	`xs_·th
(
·th
), 
	`tİod
(
t
), 
	$owÃr_vm
(
o
){}

27 
	}
};

	@
1
.
1
/usr/include
15
137
cpu.cpp
cpu.h
main.cpp
node.cpp
node.h
pnode.cpp
pnode.h
topo_change_d.cpp
topo_change_d.h
util.cpp
util.h
vm.cpp
vm.h
vnode.cpp
vnode.h
